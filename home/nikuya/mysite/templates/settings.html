<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="settings-container">
        <h1>Settings</h1>
        <div class="tabs">
            <button class="tab-btn active" data-tab="weekday">平日</button>
            <button class="tab-btn" data-tab="weekend">週末</button>
            <button class="tab-btn" data-tab="today">本日のみ</button>
            <button class="tab-btn" data-tab="sound">通知音</button>
        </div>
        <div class="tab-content" id="tab-weekday">
            <h2>平日の営業時間</h2>
            <form id="form-weekday" class="hours-form">
                <label>Open: <input type="time" name="open" value="16:00"></label><br>
                <label>L.O.: <input type="time" name="order_stop" value="22:30"></label><br>
                <label>Close: <input type="time" name="close" value="23:00"></label><br>
                <button type="submit">Save</button>
            </form>
        </div>
        <div class="tab-content" id="tab-weekend" hidden>
            <h2>週末の営業時間</h2>
            <form id="form-weekend" class="hours-form">
                <label>Open: <input type="time" name="open" value="11:00"></label><br>
                <label>L.O.: <input type="time" name="order_stop" value="22:30"></label><br>
                <label>Close: <input type="time" name="close" value="23:00"></label><br>
                <button type="submit">Save</button>
            </form>
        </div>
                <div class="tab-content" id="tab-today" hidden>
            <h2>本日の営業時間</h2>
            <p>本日のみの営業時間を設定します。設定がない場合は、曜日に応じて自動的に平日または週末の時間が適用されます。</p>
            <form id="form-today" class="hours-form">
                <label>Open: <input type="time" name="open"></label><br>
                <label>Order Stop: <input type="time" name="order_stop"></label><br>
                <label>Close: <input type="time" name="close"></label>
            </form>
        </div>

        <div class="tab-content" id="tab-sound" hidden>
            <h2>通知音設定</h2>
            <div class="sound-settings">
                <div class="sound-setting-item">
                    <label>新規注文通知音:</label>
                    <select id="new-order-sound">
                        <option value="sound1">サウンド1</option>
                        <option value="sound2">サウンド2</option>
                        <option value="sound3">サウンド3</option>
                        <option value="sound4">サウンド4</option>
                        <option value="sound5">サウンド5</option>
                        <option value="sound6">サウンド6</option>
                        <option value="sound7">サウンド7</option>
                        <option value="sound8">サウンド8</option>
                    </select>
                    <button onclick="testSound('new_order')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>注文完了/キャンセル通知音:</label>
                    <select id="order-toggle-sound">
                        <option value="sound1">サウンド1</option>
                        <option value="sound2">サウンド2</option>
                        <option value="sound3">サウンド3</option>
                        <option value="sound4">サウンド4</option>
                        <option value="sound5">サウンド5</option>
                        <option value="sound6">サウンド6</option>
                        <option value="sound7">サウンド7</option>
                        <option value="sound8">サウンド8</option>
                    </select>
                    <button onclick="testSound('order_toggle')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>コース開始通知音:</label>
                    <select id="course-start-sound">
                        <option value="sound1">サウンド1</option>
                        <option value="sound2">サウンド2</option>
                        <option value="sound3">サウンド3</option>
                        <option value="sound4">サウンド4</option>
                        <option value="sound5">サウンド5</option>
                        <option value="sound6">サウンド6</option>
                        <option value="sound7">サウンド7</option>
                        <option value="sound8">サウンド8</option>
                    </select>
                    <button onclick="testSound('course_start')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>注文時間終了通知音:</label>
                    <select id="order-time-end-sound">
                        <option value="sound1">サウンド1</option>
                        <option value="sound2">サウンド2</option>
                        <option value="sound3">サウンド3</option>
                        <option value="sound4">サウンド4</option>
                        <option value="sound5">サウンド5</option>
                        <option value="sound6">サウンド6</option>
                        <option value="sound7">サウンド7</option>
                        <option value="sound8">サウンド8</option>
                    </select>
                    <button onclick="testSound('order_time_end')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>席時間終了通知音:</label>
                    <select id="seat-time-end-sound">
                        <option value="sound1">サウンド1</option>
                        <option value="sound2">サウンド2</option>
                        <option value="sound3">サウンド3</option>
                        <option value="sound4">サウンド4</option>
                        <option value="sound5">サウンド5</option>
                        <option value="sound6">サウンド6</option>
                        <option value="sound7">サウンド7</option>
                        <option value="sound8">サウンド8</option>
                    </select>
                    <button onclick="testSound('seat_time_end')" class="test-sound-btn">テスト</button>
                </div>
            </div>
            <audio id="sound1" src="/static/sounds/sound1.mp3"></audio>
            <audio id="sound2" src="/static/sounds/sound2.mp3"></audio>
            <audio id="sound3" src="/static/sounds/sound3.mp3"></audio>
            <audio id="sound4" src="/static/sounds/sound4.mp3"></audio>
            <audio id="sound5" src="/static/sounds/sound5.mp3"></audio>
            <audio id="sound6" src="/static/sounds/sound6.mp3"></audio>
            <audio id="sound7" src="/static/sounds/sound7.mp3"></audio>
            <audio id="sound8" src="/static/sounds/sound8.mp3"></audio>
        </div>

        <div class="notice-section">
            <h2>お知らせ設定</h2>
            <textarea id="notice-text" placeholder="お知らせを入力..."></textarea>
        </div>
        <div class="website-update-section">
            <h2>3ヶ月間更新しないとサイトは閉鎖されてしまいます！<br>今すぐ「Run until 3 months from today」をクリックしてください！</h2>
            <a href="https://www.pythonanywhere.com/user/nikuya/" target="_blank" class="website-update-link" id="update-link">ここをタップして更新しに行く</a><br>
            <span id="last-update">最終更新日時: -</span>
        </div>
    </div>
    <script>
        // Show last update time from localStorage
        function updateLastUpdateText() {
            const last = localStorage.getItem('nikuya_last_update');
            document.getElementById('last-update').textContent = 'Last updated: ' + (last || '-');
        }
        updateLastUpdateText();
        document.getElementById('update-link').addEventListener('click', function() {
            const now = new Date();
            const formatted = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
            localStorage.setItem('nikuya_last_update', formatted);
            updateLastUpdateText();
        });
        // タブ切り替え
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(tc => {
                    tc.style.display = 'none';
                    tc.removeAttribute('hidden'); // hidden属性も外す
                });
                document.getElementById('tab-' + this.dataset.tab).style.display = '';
            });
        });

        // 設定の初期値取得
        fetch('/api/settings').then(res => res.json()).then(data => {
            if (data.weekday) {
                document.querySelector('#form-weekday [name=open]').value = data.weekday.open || '16:00';
                document.querySelector('#form-weekday [name=order_stop]').value = data.weekday.order_stop || '22:30';
                document.querySelector('#form-weekday [name=close]').value = data.weekday.close || '23:00';
            }
            if (data.weekend) {
                document.querySelector('#form-weekend [name=open]').value = data.weekend.open || '11:00';
                document.querySelector('#form-weekend [name=order_stop]').value = data.weekend.order_stop || '22:30';
                document.querySelector('#form-weekend [name=close]').value = data.weekend.close || '23:00';
            }
            if (data.today) {
                document.querySelector('#form-today [name=open]').value = data.today.open || '';
                document.querySelector('#form-today [name=order_stop]').value = data.today.order_stop || '';
                document.querySelector('#form-today [name=close]').value = data.today.close || '';
            }
            if (data.notice !== undefined) {
                document.querySelector('#website-update-form [name=notice]').value = data.notice;
            }
            if (data.sounds) {
                document.getElementById('new-order-sound').value = data.sounds.new_order || 'default';
                document.getElementById('timer-alert-sound').value = data.sounds.timer_alert || 'default';
            }
        });

        // 各フォームの保存
        document.getElementById('form-weekday').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('weekday');
        };
        document.getElementById('form-weekend').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('weekend');
        };
        document.getElementById('form-today').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('today');
        };
        document.getElementById('website-update-form').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('notice');
        };

        function saveSettings(type) {
            fetch('/api/settings').then(res => res.json()).then(data => {
                if (type === 'notice') {
                    data.notice = document.querySelector('#website-update-form [name=notice]').value;
                } else if (type === 'sounds') {
                    if (!data.sounds) data.sounds = {};
                    data.sounds.new_order = document.getElementById('new-order-sound').value;
                    data.sounds.timer_alert = document.getElementById('timer-alert-sound').value;
                } else {
                    if (!data[type]) data[type] = {};
                    data[type].open = document.querySelector(`#form-${type} [name=open]`).value;
                    data[type].order_stop = document.querySelector(`#form-${type} [name=order_stop]`).value;
                    data[type].close = document.querySelector(`#form-${type} [name=close]`).value;
                }
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json()).then(r => {
                    if (r.success) alert('保存しました');
                });
            });
        }

        // 音声設定の自動保存
        document.getElementById('new-order-sound').addEventListener('change', () => saveSettings('sounds'));
        document.getElementById('timer-alert-sound').addEventListener('change', () => saveSettings('sounds'));

        // テスト音声の再生
        function testSound(type) {
            let soundType = type === 'order' ? 
                document.getElementById('new-order-sound').value : 
                document.getElementById('timer-alert-sound').value;
            
            let audioId;
            switch (soundType) {
                case 'bell':
                    audioId = 'bell-sound';
                    break;
                case 'chime':
                    audioId = 'chime-sound';
                    break;
                case 'ding':
                    audioId = 'ding-sound';
                    break;
                default:
                    audioId = 'timer-sound';
            }
            document.getElementById(audioId).play();
        }
    </script>
</body>
</html>
