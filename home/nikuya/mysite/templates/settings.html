<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="settings-container">
        <h1>Settings</h1>
        <div class="tabs">
            <button class="tab-btn active" data-tab="weekday">平日</button>
            <button class="tab-btn" data-tab="weekend">週末</button>
            <button class="tab-btn" data-tab="today">本日のみ</button>
            <button class="tab-btn" data-tab="sound">通知音</button>
        </div>
        <div class="tab-content" id="tab-weekday">
            <h2>平日の営業時間</h2>
            <form id="form-weekday" class="hours-form">
                <label>Open: <input type="time" name="open" value="16:00"></label><br>
                <label>L.O.: <input type="time" name="order_stop" value="22:30"></label><br>
                <label>Close: <input type="time" name="close" value="23:00"></label><br>
                <button type="submit">Save</button>
            </form>
        </div>
        <div class="tab-content" id="tab-weekend" hidden>
            <h2>週末の営業時間</h2>
            <form id="form-weekend" class="hours-form">
                <label>Open: <input type="time" name="open" value="11:00"></label><br>
                <label>L.O.: <input type="time" name="order_stop" value="22:30"></label><br>
                <label>Close: <input type="time" name="close" value="23:00"></label><br>
                <button type="submit">Save</button>
            </form>
        </div>
                <div class="tab-content" id="tab-today" hidden>
            <h2>本日の営業時間</h2>
            <p>本日のみの営業時間を設定します。設定がない場合は、曜日に応じて自動的に平日または週末の時間が適用されます。</p>
            <form id="form-today" class="hours-form">
                <label>Open: <input type="time" name="open"></label><br>
                <label>Order Stop: <input type="time" name="order_stop"></label><br>
                <label>Close: <input type="time" name="close"></label>
            </form>
        </div>

        <div class="tab-content" id="tab-sound" hidden>
            <h2>通知音設定</h2>
            <div class="sound-settings">
                <div class="sound-setting-item">
                    <label>新規注文通知音:<br></label>
                    <select id="new-order-sound">
                        <!-- 音声ファイルのオプションを動的に生成 -->
                    </select>
                    <button onclick="testSound('new_order')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>注文完了/キャンセル通知音:<br></label>
                    <select id="order-toggle-sound">
                        <!-- 音声ファイルのオプションを動的に生成 -->
                    </select>
                    <button onclick="testSound('order_toggle')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>コース開始通知音:<br></label>
                    <select id="course-start-sound">
                        <!-- 音声ファイルのオプションを動的に生成 -->
                    </select>
                    <button onclick="testSound('course_start')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>注文時間終了通知音:<br></label>
                    <select id="order-time-end-sound">
                        <!-- 音声ファイルのオプションを動的に生成 -->
                    </select>
                    <button onclick="testSound('order_time_end')" class="test-sound-btn">テスト</button>
                </div>
                <div class="sound-setting-item">
                    <label>席時間終了通知音:<br></label>
                    <select id="seat-time-end-sound">
                        <!-- 音声ファイルのオプションを動的に生成 -->
                    </select>
                    <button onclick="testSound('seat_time_end')" class="test-sound-btn">テスト</button>
                </div>
            </div>
            <!-- 全ての音声ファイルを動的に生成 -->
            <script>
                const allSoundFiles = [
                    'アイテムを入手1.mp3','アイテムを入手2.mp3','アヒルが大笑い.mp3','エアーホーン.mp3','お寺の鐘.mp3',
                    'カウントダウン電子音.mp3','カキーンと打つ.mp3','カタカタ震える.mp3','きらーん1.mp3','きらーん2.mp3',
                    'きらきら輝く1.mp3','きらきら輝く2.mp3','きらきら輝く3.mp3','きらきら輝く4.mp3','きらきら輝く5.mp3','きらきら輝く6.mp3',
                    'キラッ1.mp3','キラッ2.mp3','クイズ出題1.mp3','クイズ出題2.mp3','クイズ正解1.mp3','クイズ正解2.mp3','クイズ正解3.mp3','クイズ正解4.mp3','クイズ正解5.mp3',
                    'クイズ早押しボタン1.mp3','クイズ早押しボタン2.mp3','クイズ不正解1.mp3','クイズ不正解2.mp3','グサッ1.mp3','グサッ2.mp3','くすぐる.mp3','ゴゴゴゴ.mp3','サンタクロースの鈴.mp3',
                    'シーン切り替え1.mp3','シーン切り替え2.mp3','シャキーン1.mp3','シャキーン2.mp3','シャキーン3.mp3','ジャジャーン.mp3','ジャン！.mp3','ジャンプ.mp3','しょげる.mp3',
                    'ショック1.mp3','ショック2.mp3','ショック3.mp3','ショック4.mp3','ショック5.mp3','ショック6.mp3','スイッチを押す.mp3','スタジアムの歓声.mp3','ずっこける.mp3','スポッ.mp3','スポットライトが当たる.mp3',
                    'タイトル表示.mp3','タイプライターで文字を打つ1.mp3','タイプライターで文字を打つ2.mp3','チーン1.mp3','チーン2.mp3','ちゃんちゃん♪1.mp3','ちゃんちゃん♪2.mp3','ちゃんちゃん♪3.mp3','ちょこっと触る.mp3','チリン.mp3',
                    'ツルっとすべる.mp3','ティンパニロール.mp3','データ解析.mp3','ドーン (1).mp3','ドーン.mp3','ドラムロール.mp3','トランペットのグリスダウン.mp3','ドンドンパフパフ.mp3',
                    'ニュースタイトル表示1.mp3','ニュースタイトル表示2.mp3','ニュースタイトル表示3.mp3','ニュースタイトル表示4.mp3','ニュッ1.mp3','ニュッ2.mp3','ニュッ3.mp3','バーン.mp3',
                    'バイオリン恐怖音1.mp3','バイオリン恐怖音2.mp3','バイオリン恐怖音3.mp3','パッ.mp3','パパッ.mp3','パフ.mp3','ピアノの単音.mp3','ヒーローの決めポーズ.mp3','ピコッ.mp3',
                    'ビシッとツッコミ1.mp3','ビシッとツッコミ2.mp3','ビシッとツッコミ3.mp3','ひたひたと何かが近づく1.mp3','ひたひたと何かが近づく2.mp3','ピューンと逃げる.mp3','ヒューンと落下.mp3','ヒヨコが頭の上を回るmp3.mp3','ひらめく1.mp3','ひらめく2.mp3',
                    'ブウーン.mp3','ぷよん.mp3','プレゼンタイトル表示1.mp3','プレゼンタイトル表示2.mp3','へたくそトランペット.mp3','ペタッ.mp3','ポカンとげんこつ.mp3','ボヨヨーン.mp3','ボヨン.mp3','ホラータイトル表示音.mp3','ホラー文字表示音.mp3','ほら貝を吹き鳴らす.mp3',
                    'ラーメン屋台登場.mp3','ラッパのファンファーレ.mp3','レベルアップ.mp3','ロールの閉め.mp3','運命1.mp3','運命2.mp3','映写機.mp3','煙モクモク.mp3','黄色い悲鳴.mp3',
                    '可愛い足音.mp3','可愛い動作.mp3','可愛く輝く1.mp3','可愛く輝く2.mp3','可愛く座る.mp3','過去を思い出す.mp3','回想.mp3','開演ブザー.mp3','学校のチャイム.mp3','噛みつく.mp3','寒いギャグで突風が吹く.mp3','歓声と拍手.mp3',
                    '間抜け1.mp3','間抜け2.mp3','間抜け3.mp3','間抜け4.mp3','間抜け5.mp3','間抜け6.mp3','間抜け7.mp3','恐怖.mp3','恐怖の不協和音.mp3','教会の祈り.mp3','教会の鐘1.mp3','教会の鐘2.mp3','狂気.mp3','驚く.mp3','琴の滑奏.mp3',
                    '金額表示.mp3','金属タイトル表示1.mp3','金属タイトル表示2.mp3','金属タイトル表示3.mp3','靴でブレーキ.mp3','警報が鳴る.mp3','試合開始のゴング.mp3','試合終了のゴング.mp3','時代劇演出1.mp3','時代劇演出2.mp3','時代劇演出3.mp3','自主規制ピー音.mp3','尺八.mp3','呪いの旋律.mp3','縮む.mp3',
                    '女衆「おう！」.mp3','小鼓（こつづみ）.mp3','食べ物をパクッ.mp3','伸びる.mp3','心臓の鼓動1.mp3','心臓の鼓動2.mp3','真夜中に鳴り出すピアノ.mp3','制限時間タイマー.mp3','制限時間タイマー（倍速）.mp3','絶望.mp3','蘇るトラウマ.mp3','荘厳な雰囲気.mp3','足首がグキッ.mp3',
                    '対戦カード表示1.mp3','対戦カード表示2.mp3','大勢で拍手.mp3','男衆「イエーイ！」.mp3','男衆「イヤッホー！」.mp3','男衆「オウ！」.mp3','男衆「喝！」.mp3','男衆「始めいッ！」.mp3','男性の悲鳴.mp3','男声「ハイ！ハイ！...」.mp3','超高速ダッシュ.mp3','鳥の奇声.mp3','突撃ラッパ.mp3','肉を食べる.mp3','忍び寄る恐怖.mp3',
                    '拍子木1.mp3','拍子木2.mp3','拍子木3.mp3','爆発1.mp3','爆発2.mp3','鳩時計1.mp3','鳩時計2.mp3','不安（ピアノ演奏）.mp3','文字アニメーション1.mp3','文字アニメーション2.mp3','文字表示の衝撃音1.mp3','文字表示の衝撃音2.mp3','文字表示の衝撃音3.mp3','宝箱を開ける.mp3','放送開始チャイム.mp3','放送終了チャイム.mp3',
                    '魔の時計塔の鐘.mp3','木魚ポク・ポク・ポク.mp3','目が点になる.mp3','目をパチパチ.mp3','幽霊が現れる.mp3','落ち込む.mp3','涙のしずく.mp3','鈴を鳴らす.mp3','和太鼓でカカッ.mp3','和太鼓でドドン.mp3','和太鼓でドン.mp3'
                ];
                
                // selectボックスに音声ファイルのオプションを追加
                const selectIds = ['new-order-sound', 'order-toggle-sound', 'course-start-sound', 'order-time-end-sound', 'seat-time-end-sound'];
                selectIds.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    allSoundFiles.forEach(fn => {
                        const option = document.createElement('option');
                        const id = fn.replace(/\.mp3$/,'').replace(/[^\w\-]/g,'_');
                        option.value = id;
                        option.textContent = fn.replace('.mp3', '');
                        select.appendChild(option);
                    });
                });
                
                // 音声エレメントを作成
                allSoundFiles.forEach(fn => {
                    const id = fn.replace(/\.mp3$/,'').replace(/[^\w\-]/g,'_');
                    const audio = document.createElement('audio');
                    audio.id = id;
                    audio.src = `/static/sounds/${fn}`;
                    document.body.appendChild(audio);
                });
            </script>
        </div>
        <div class="website-update-section">
            <h2>3ヶ月間更新しないとサイトは閉鎖されてしまいます！<br>今すぐ「Run until 3 months from today」をクリックしてください！</h2>
            <a href="https://www.pythonanywhere.com/user/nikuya/" target="_blank" class="website-update-link" id="update-link">ここをタップして更新しに行く</a><br>
            <span id="last-update">最終更新日時: -</span>
        </div>
    </div>
    <script>
        // Show last update time from localStorage
        function updateLastUpdateText() {
            const last = localStorage.getItem('nikuya_last_update');
            document.getElementById('last-update').textContent = 'Last updated: ' + (last || '-');
        }
        updateLastUpdateText();
        document.getElementById('update-link').addEventListener('click', function() {
            const now = new Date();
            const formatted = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
            localStorage.setItem('nikuya_last_update', formatted);
            updateLastUpdateText();
        });
        // タブ切り替え
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(tc => {
                    tc.style.display = 'none';
                    tc.removeAttribute('hidden'); // hidden属性も外す
                });
                document.getElementById('tab-' + this.dataset.tab).style.display = '';
            });
        });

        // 設定の初期値取得
        fetch('/api/settings').then(res => res.json()).then(data => {
            if (data.weekday) {
                document.querySelector('#form-weekday [name=open]').value = data.weekday.open || '16:00';
                document.querySelector('#form-weekday [name=order_stop]').value = data.weekday.order_stop || '22:30';
                document.querySelector('#form-weekday [name=close]').value = data.weekday.close || '23:00';
            }
            if (data.weekend) {
                document.querySelector('#form-weekend [name=open]').value = data.weekend.open || '11:00';
                document.querySelector('#form-weekend [name=order_stop]').value = data.weekend.order_stop || '22:30';
                document.querySelector('#form-weekend [name=close]').value = data.weekend.close || '23:00';
            }
            if (data.today) {
                document.querySelector('#form-today [name=open]').value = data.today.open || '';
                document.querySelector('#form-today [name=order_stop]').value = data.today.order_stop || '';
                document.querySelector('#form-today [name=close]').value = data.today.close || '';
            }
            if (data.notice !== undefined) {
                document.querySelector('#website-update-form [name=notice]').value = data.notice;
            }
            if (data.sounds) {
                document.getElementById('new-order-sound').value = data.sounds.new_order || '______________1';
                document.getElementById('order-toggle-sound').value = data.sounds.order_toggle || '______________2';
                document.getElementById('course-start-sound').value = data.sounds.course_start || '________________';
                document.getElementById('order-time-end-sound').value = data.sounds.order_time_end || '________________________';
                document.getElementById('seat-time-end-sound').value = data.sounds.seat_time_end || '____________';
            }
        });

        // 各フォームの保存
        document.getElementById('form-weekday').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('weekday');
        };
        document.getElementById('form-weekend').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('weekend');
        };
        document.getElementById('form-today').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('today');
        };
        document.getElementById('website-update-form').onsubmit = function(e) {
            e.preventDefault();
            saveSettings('notice');
        };

        function saveSettings(type) {
            fetch('/api/settings').then(res => res.json()).then(data => {
                if (type === 'notice') {
                    data.notice = document.querySelector('#website-update-form [name=notice]').value;
                } else if (type === 'sounds') {
                    if (!data.sounds) data.sounds = {};
                    data.sounds.new_order = document.getElementById('new-order-sound').value;
                    data.sounds.order_toggle = document.getElementById('order-toggle-sound').value;
                    data.sounds.course_start = document.getElementById('course-start-sound').value;
                    data.sounds.order_time_end = document.getElementById('order-time-end-sound').value;
                    data.sounds.seat_time_end = document.getElementById('seat-time-end-sound').value;
                } else {
                    if (!data[type]) data[type] = {};
                    data[type].open = document.querySelector(`#form-${type} [name=open]`).value;
                    data[type].order_stop = document.querySelector(`#form-${type} [name=order_stop]`).value;
                    data[type].close = document.querySelector(`#form-${type} [name=close]`).value;
                }
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json()).then(r => {
                    if (r.success) alert('保存しました');
                });
            });
        }

        // 音声設定の自動保存
        document.getElementById('new-order-sound').addEventListener('change', () => saveSettings('sounds'));
        document.getElementById('order-toggle-sound').addEventListener('change', () => saveSettings('sounds'));
        document.getElementById('course-start-sound').addEventListener('change', () => saveSettings('sounds'));
        document.getElementById('order-time-end-sound').addEventListener('change', () => saveSettings('sounds'));
        document.getElementById('seat-time-end-sound').addEventListener('change', () => saveSettings('sounds'));

        // テスト音声の再生
        function testSound(type) {
            let soundId;
            switch (type) {
                case 'new_order':
                    soundId = document.getElementById('new-order-sound').value;
                    break;
                case 'order_toggle':
                    soundId = document.getElementById('order-toggle-sound').value;
                    break;
                case 'course_start':
                    soundId = document.getElementById('course-start-sound').value;
                    break;
                case 'order_time_end':
                    soundId = document.getElementById('order-time-end-sound').value;
                    break;
                case 'seat_time_end':
                    soundId = document.getElementById('seat-time-end-sound').value;
                    break;
            }
            const audio = document.getElementById(soundId);
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }
    </script>
</body>
</html>
