<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>座席管理</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="manage-container">
  <div class="manage-title">管理画面</div>
  <section id="seatSection" class="manage-section active">
    <h2 class="manage-section-title">座席管理</h2>
    <div class="manage-actions seat-actions">
      <label for="sortOrder" class="manage-label">並び順</label>
      <select id="sortOrder" class="manage-select">
        <option value="asc">小さい順</option>
        <option value="desc">大きい順</option>
      </select>
    </div>
    <div class="seat-list manage-list" id="seatList"></div>
    <form class="add-form manage-form" id="addSeatForm" autocomplete="off">
      <input type="number" id="newSeat" class="manage-input" placeholder="座席番号" min="1" required>
      <button type="submit" class="manage-btn add-btn">追加</button>
    </form>
    <div id="actionBtns" class="manage-action-btns">
      <button id="editBtn" class="manage-btn edit-btn">編集</button>
      <button id="deleteBtn" class="manage-btn delete-btn">削除</button>
    </div>
    <div id="seatError" class="manage-error"></div>
  </section>
  <section id="courseSection" class="manage-section">
    <h2 class="manage-section-title">コース管理</h2>
    <div class="manage-actions course-actions">
      <label for="courseSort" class="manage-label">並び順</label>
      <select id="courseSort" class="manage-select">
        <option value="asc">小さい順</option>
        <option value="desc">大きい順</option>
      </select>
    </div>
    <div class="course-list manage-list" id="courseList"></div>
    <form class="add-form manage-form" id="addCourseForm" autocomplete="off">
      <input type="text" id="newCourseId" class="manage-input" placeholder="コースID" required>
      <input type="text" id="newCourseName" class="manage-input" placeholder="コース名" required>
      <button type="submit" class="manage-btn add-btn">追加</button>
    </form>
    <div id="courseActionBtns" class="manage-action-btns">
      <button id="editCourseBtn" class="manage-btn edit-btn">編集</button>
      <button id="deleteCourseBtn" class="manage-btn delete-btn">削除</button>
      <button id="toggleCourseBtn" class="manage-btn toggle-btn">表示/非表示</button>
    </div>
    <div id="courseError" class="manage-error"></div>
  </section>
  <section id="dishSection" class="manage-section">
    <h2 class="manage-section-title">商品管理</h2>
    <div class="manage-actions dish-actions">
      <label for="dishCourse" class="manage-label">コース</label>
      <select id="dishCourse" class="manage-select"></select>
      <label for="dishSort" class="manage-label">並び順</label>
      <select id="dishSort" class="manage-select">
        <option value="asc">小さい順</option>
        <option value="desc">大きい順</option>
      </select>
    </div>
    <div class="dish-list manage-list" id="dishList"></div>
    <form class="add-form manage-form" id="addDishForm" autocomplete="off">
      <input type="text" id="newDishCategory" class="manage-input" placeholder="カテゴリ" required>
      <input type="text" id="newDishId" class="manage-input" placeholder="商品ID" required>
      <input type="text" id="newDishName" class="manage-input" placeholder="商品名" required>
      <button type="submit" class="manage-btn add-btn">追加</button>
    </form>
    <div id="dishActionBtns" class="manage-action-btns">
      <button id="editDishBtn" class="manage-btn edit-btn">編集</button>
      <button id="deleteDishBtn" class="manage-btn delete-btn">削除</button>
      <button id="toggleDishBtn" class="manage-btn toggle-btn">表示/非表示</button>
    </div>
    <div id="dishError" class="manage-error"></div>
  </section>
</div>
<script>
// ======== セクション管理 ========
function showSection(sectionId) {
  // すべてのセクションを非表示
  document.querySelectorAll('.manage-section').forEach(section => {
    section.classList.remove('active');
  });
  // 選択されたセクションを表示
  document.getElementById(sectionId).classList.add('active');
}

// セクション切り替えボタン
const navItems = [
  { id: 'seatSection', text: '座席管理' },
  { id: 'courseSection', text: 'コース管理' },
  { id: 'dishSection', text: '商品管理' }
];

// ナビゲーションボタンの作成
const nav = document.createElement('div');
nav.className = 'section-nav';
navItems.forEach(item => {
  const button = document.createElement('button');
  button.className = 'section-nav-btn';
  button.textContent = item.text;
  button.onclick = () => showSection(item.id);
  nav.appendChild(button);
});

// ナビゲーションを.manage-containerの最初に挿入
document.querySelector('.manage-container').insertBefore(nav, document.querySelector('.manage-title'));

// ======== 座席管理 ========
let seat_selected = null;
function seat_reload() {
  const order = document.getElementById('sortOrder').value;
  fetch(`/api/seats?order=${order}`)
    .then(res => res.json())
    .then(seats => {
      const seatList = document.getElementById('seatList');
      seatList.innerHTML = '';
      if (!Array.isArray(seats) || seats.length === 0) {
        seatList.innerHTML = '<div style="color:#888;text-align:center;width:100%;">座席がありません</div>';
      } else {
        seats.forEach(seat => {
          const div = document.createElement('div');
          div.className = 'seat-item';
          div.textContent = seat;
          div.onclick = () => seat_select(div, seat);
          if (seat_selected === seat) div.classList.add('selected');
          seatList.appendChild(div);
        });
      }
      seat_updateBtns();
      document.getElementById('seatError').style.display = 'none';
    })
    .catch(e => {
      document.getElementById('seatList').innerHTML = '<div style="color:#c00;text-align:center;width:100%;">座席の取得に失敗</div>';
      document.getElementById('seatError').textContent = '座席の取得に失敗しました';
      document.getElementById('seatError').style.display = '';
    });
}

function seat_select(div, seat) {
  seat_selected = seat;
  document.querySelectorAll('.seat-item').forEach(d => d.classList.remove('selected'));
  div.classList.add('selected');
  seat_updateBtns();
}

function seat_updateBtns() {
  const btns = document.getElementById('actionBtns');
  if (seat_selected !== null) btns.style.display = 'flex';
  else btns.style.display = 'none';
}

document.getElementById('addSeatForm').onsubmit = function(e) {
  e.preventDefault();
  const seat = document.getElementById('newSeat').value;
  fetch('/api/seats', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ seat: Number(seat) })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('newSeat').value = '';
        seat_selected = null;
        seat_reload();
      } else {
        document.getElementById('seatError').textContent = data.error || '追加失敗';
        document.getElementById('seatError').style.display = '';
      }
    });
};

document.getElementById('editBtn').onclick = function() {
  if (seat_selected === null) return;
  const newSeat = prompt(`座席 ${seat_selected} を編集します。新しい番号を入力してください:`, seat_selected);
  if (newSeat && !isNaN(newSeat)) {
    fetch(`/api/seats/${seat_selected}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ seat: Number(newSeat) })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          seat_selected = null;
          seat_reload();
        } else {
          document.getElementById('seatError').textContent = data.error || '編集失敗';
          document.getElementById('seatError').style.display = '';
        }
      });
  }
};

document.getElementById('deleteBtn').onclick = function() {
  if (seat_selected === null) return;
  if (!confirm(`座席 ${seat_selected} を削除しますか？`)) return;
  fetch(`/api/seats/${seat_selected}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        seat_selected = null;
        seat_reload();
      } else {
        document.getElementById('seatError').textContent = data.error || '削除失敗';
        document.getElementById('seatError').style.display = '';
      }
    });
};

document.getElementById('sortOrder').addEventListener('change', seat_reload);

// ======== コース管理 ========
let course_selected = null;
function course_reload() {
  const order = document.getElementById('courseSort').value;
  fetch(`/api/courses?order=${order}`)
    .then(res => res.json())
    .then(courses => {
      const courseList = document.getElementById('courseList');
      courseList.innerHTML = '';
      if (!Array.isArray(courses) || courses.length === 0) {
        courseList.innerHTML = '<div style="color:#888;text-align:center;width:100%;">コースがありません</div>';
      } else {
        courses.forEach(course => {
          const div = document.createElement('div');
          div.className = 'seat-item';
          div.textContent = `${course.name} (${course.id})` + (course.hidden ? ' [非表示]' : '');
          div.onclick = () => course_select(div, course);
          if (course_selected && course_selected.id === course.id) div.classList.add('selected');
          courseList.appendChild(div);
        });
      }
      course_updateBtns();
      document.getElementById('courseError').style.display = 'none';
    })
    .catch(e => {
      document.getElementById('courseList').innerHTML = '<div style="color:#c00;text-align:center;width:100%;">コースの取得に失敗</div>';
      document.getElementById('courseError').textContent = 'コースの取得に失敗しました';
      document.getElementById('courseError').style.display = '';
    });
}

function course_select(div, course) {
  course_selected = course;
  document.querySelectorAll('.course-list .seat-item').forEach(d => d.classList.remove('selected'));
  div.classList.add('selected');
  course_updateBtns();
}

function course_updateBtns() {
  const btns = document.getElementById('courseActionBtns');
  if(course_selected) btns.style.display = 'flex';
  else btns.style.display = 'none';
}

document.getElementById('addCourseForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('newCourseId').value.trim();
  const name = document.getElementById('newCourseName').value.trim();
  fetch('/api/courses', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, name })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('newCourseId').value = '';
        document.getElementById('newCourseName').value = '';
        course_selected = null;
        course_reload();
        dish_reloadCourses();
      } else {
        document.getElementById('courseError').textContent = data.error || '追加失敗';
        document.getElementById('courseError').style.display = '';
      }
    });
};

document.getElementById('editCourseBtn').onclick = function() {
  if (!course_selected) return;
  const newId = prompt(`コースIDを編集 (${course_selected.id}):`, course_selected.id);
  const newName = prompt(`コース名を編集 (${course_selected.name}):`, course_selected.name);
  if (newId !== null && newName !== null) {
    fetch(`/api/courses/${course_selected.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: newId, name: newName })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          course_selected = null;
          course_reload();
          dish_reloadCourses();
        } else {
          document.getElementById('courseError').textContent = data.error || '編集失敗';
          document.getElementById('courseError').style.display = '';
        }
      });
  }
};

document.getElementById('deleteCourseBtn').onclick = function() {
  if (!course_selected) return;
  if (!confirm(`コース ${course_selected.name} (${course_selected.id}) を削除しますか？`)) return;
  fetch(`/api/courses/${course_selected.id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        course_selected = null;
        course_reload();
        dish_reloadCourses();
      } else {
        document.getElementById('courseError').textContent = data.error || '削除失敗';
        document.getElementById('courseError').style.display = '';
      }
    });
};

document.getElementById('toggleCourseBtn').onclick = function() {
  if (!course_selected) return;
  fetch(`/api/courses/${course_selected.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ hidden: !course_selected.hidden })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        course_selected = null;
        course_reload();
        dish_reloadCourses();
      } else {
        document.getElementById('courseError').textContent = data.error || '切替失敗';
        document.getElementById('courseError').style.display = '';
      }
    });
};

document.getElementById('courseSort').addEventListener('change', course_reload);

// ======== 商品管理 ========
let dish_selected = null;
let dish_currentCourse = '';

function dish_reloadCourses(){
  fetch('/api/courses')
    .then(res=>res.json())
    .then(courses=>{
      const sel = document.getElementById('dishCourse');
      sel.innerHTML = '<option value="">コース選択</option>';
      if(Array.isArray(courses)){
        courses.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = `${c.name} (${c.id})`;
          sel.appendChild(opt);
        });
      }
      dish_reload();
    })
    .catch(e => {
      const sel = document.getElementById('dishCourse');
      sel.innerHTML = '<option disabled>コース取得失敗</option>';
      document.getElementById('dishList').innerHTML = '';
    });
}

function dish_reload(){
  const courseId = document.getElementById('dishCourse').value;
  dish_currentCourse = courseId;
  if(!courseId){document.getElementById('dishList').innerHTML='';return;}
  const order = document.getElementById('dishSort').value;
  fetch(`/api/dishes/${courseId}?order=${order}`)
    .then(res=>res.json())
    .then(dishes=>{
      const dishList = document.getElementById('dishList');
      dishList.innerHTML = '';
      if(!Array.isArray(dishes) || dishes.length===0){
        dishList.innerHTML = '<div style="color:#888;text-align:center;width:100%;">商品がありません</div>';
      }else{
        dishes.forEach(dish=>{
          const div = document.createElement('div');
          div.className = 'seat-item';
          div.textContent = `${dish.name} (${dish.id}) [${dish.category}]` + (dish.hidden ? ' [非表示]' : '');
          div.onclick = () => dish_select(div, dish);
          if(dish_selected && dish_selected.id===dish.id) div.classList.add('selected');
          dishList.appendChild(div);
        });
      }
      dish_updateBtns();
      document.getElementById('dishError').style.display = 'none';
    })
    .catch(e => {
      document.getElementById('dishList').innerHTML = '<div style="color:#c00;text-align:center;width:100%;">商品の取得に失敗</div>';
      document.getElementById('dishError').textContent = '商品の取得に失敗しました';
      document.getElementById('dishError').style.display = '';
    });
}

function dish_select(div, dish){
  dish_selected = dish;
  document.querySelectorAll('.dish-list .seat-item').forEach(d=>d.classList.remove('selected'));
  div.classList.add('selected');
  dish_updateBtns();
}

function dish_updateBtns(){
  const btns = document.getElementById('dishActionBtns');
  if(dish_selected) btns.style.display = 'flex';
  else btns.style.display = 'none';
}

document.getElementById('addDishForm').onsubmit = function(e){
  e.preventDefault();
  if(!dish_currentCourse){document.getElementById('dishError').textContent='コースを選択してください';document.getElementById('dishError').style.display='';return;}
  const category = document.getElementById('newDishCategory').value.trim();
  const id = document.getElementById('newDishId').value.trim();
  const name = document.getElementById('newDishName').value.trim();
  fetch(`/api/dishes/${dish_currentCourse}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({category,id,name})
  })
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        document.getElementById('newDishCategory').value = '';
        document.getElementById('newDishId').value = '';
        document.getElementById('newDishName').value = '';
        dish_selected = null;
        dish_reload();
      }else{
        document.getElementById('dishError').textContent = data.error || '追加失敗';
        document.getElementById('dishError').style.display = '';
      }
    });
};

document.getElementById('editDishBtn').onclick = function(){
  if(!dish_selected||!dish_currentCourse) return;
  const newName = prompt('商品名を編集:',dish_selected.name);
  if(newName){
    fetch(`/api/dishes/${dish_currentCourse}/${dish_selected.id}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:newName})
    })
      .then(res=>res.json())
      .then(data=>{
        if(data.success){
          dish_selected = null;
          dish_reload();
        }else{
          document.getElementById('dishError').textContent = data.error || '編集失敗';
          document.getElementById('dishError').style.display = '';
        }
      });
  }
};

document.getElementById('deleteDishBtn').onclick = function(){
  if(!dish_selected||!dish_currentCourse) return;
  if(!confirm(`商品 ${dish_selected.name} (${dish_selected.id}) を削除しますか？`)) return;
  fetch(`/api/dishes/${dish_currentCourse}/${dish_selected.id}`,{method:'DELETE'})
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        dish_selected = null;
        dish_reload();
      }else{
        document.getElementById('dishError').textContent = data.error || '削除失敗';
        document.getElementById('dishError').style.display = '';
      }
    });
};

document.getElementById('toggleDishBtn').onclick = function(){
  if(!dish_selected||!dish_currentCourse) return;
  fetch(`/api/dishes/${dish_currentCourse}/${dish_selected.id}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({hidden:!dish_selected.hidden})
  })
    .then(res=>res.json())
    .then(data=>{
      if(data.success){dish_selected=null;dish_reload();}
      else{
        document.getElementById('dishError').textContent = data.error || '切替失敗';
        document.getElementById('dishError').style.display = '';
      }
    });
};

document.getElementById('dishCourse').addEventListener('change',dish_reload);
document.getElementById('dishSort').addEventListener('change',dish_reload);

// 初期化
window.onload = function(){
  showSection('seatSection');  // 初期表示は座席管理
  seat_reload();
  course_reload();
  dish_reloadCourses();
};
</script>

<!-- 下部ナビゲーション -->
<footer class="bottom-nav-footer">
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav-link">座席選択</a>
    <a href="/staff" class="bottom-nav-link">スタッフ</a>
    <a href="/settings" class="bottom-nav-link">設定</a>
  </nav>
</footer>
</body>
</html>
