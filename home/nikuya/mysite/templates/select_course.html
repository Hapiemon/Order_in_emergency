<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Selection - Seat {{ seat }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Course Selection - Seat {{ seat }}</h1>
    <div class="course-container">
        {% for course_id, course_data in courses.items() %}
            {% if not course_data.hidden %}
            <div class="course-card">
                <h2 class="course-name">{{ course_data.course_name|replace('/', '<br>')|safe }}</h2>
                <p class="price">{{ "{:,}".format(course_data.price) }} yen</p>
                <p class="description">{{ course_data.description|replace('/', '<br>')|safe }}</p>
                <form class="course-form" onsubmit="event.preventDefault(); return false;">
                    <input type="hidden" name="seat" value="{{ seat }}">
                    <input type="hidden" name="course_name" value="{{ course_id }}">
                    <button type="button" class="select-button">Select</button>
                </form>
                <div class="error-message"></div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <script>
        let isProcessing = false; // グローバルな処理状態フラグ

        async function selectCourse(form) {
            // 既に処理中の場合は何もしない
            if (isProcessing) {
                return;
            }

            const formData = new FormData(form);
            const submitButton = form.querySelector('button');
            const errorDiv = form.parentElement.querySelector('.error-message');

            // ボタンが既に処理中の場合は何もしない
            if (submitButton.disabled) {
                return;
            }

            if (!confirm('Start?')) {
                return;
            }

            try {
                // グローバルフラグと個別ボタンの両方を無効化
                isProcessing = true;
                submitButton.disabled = true;
                submitButton.textContent = 'Processing...';

                const response = await fetch('{{ url_for("set_course") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(formData).toString()
                });

                const data = await response.json();

                if (data.success) {
                    // 成功時は即座にリダイレクト
                    window.location.href = data.redirect;
                } else {
                    errorDiv.textContent = data.error || 'Failed to select course';
                    errorDiv.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Select this course';
                    isProcessing = false;
                }
            } catch (error) {
                errorDiv.textContent = 'An error occurred';
                errorDiv.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Select this course';
                isProcessing = false;
            }
        }

        // DOMContentLoadedイベントでイベントリスナーを設定
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.select-button');
            buttons.forEach(button => {
                // 既存のイベントリスナーがある場合は削除
                button.removeEventListener('click', selectCourse);
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectCourse(this.closest('form'));
                }, { once: false }); // onceオプションは使わない（エラー時の再試行のため）
            });
        });
    </script>
</body>
</html>